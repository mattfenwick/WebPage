<!doctype html>
<html>
<head>
  <title>the Fenwick Chat Machine</title>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
  <script type="text/javascript" src="dal.js"></script>
  <script type="text/javascript" src="model.js"></script>
  <link rel="stylesheet" type="text/css" href="style.css" />
</head>

<body>


 <div id="wrapper">

  <div id="main">
  
   <div id="messagehistory"></div>

   <div id="newmessage">
    new message:<textarea id="text"></textarea>
    <button id="savemessage">Save message</button>
   </div>
  
  </div> <!-- end #main--> 


  <div id="metainfo">
  
   <div id="config">
    <button id="showconfig">Show/hide configuration settings</button>
    <div id="setconfig">
     <table>
       <tr>
         <td>username</td>
         <td><input name="username" id="username" /></td>
       </tr>
       <tr>
         <td>room</td>
         <td><input id="room" name="room"/></td>
       </tr>
     </table>
     <button id="updateconfig">Save updated configuration</button>
    </div>
    <button id="togglestatus">Show/hide status</button>
   </div> <!--  end config -->
   
   <div id="currentconfig">
    <div id="currentusername"></div>
    <div id="currentroom"></div>
   </div>
   
   <div id="status"></div>
   
  </div> <!-- end #metainfo -->
  
  
  <div id="footer"></div>

 </div> <!--  end wrapper -->
 
 
<script type="text/javascript">
    
    function messageTemplate(time, username, text) {
        var myHTML = '<div><span class="time">time: ' + time + 
          '</span><span class="username">' + 'user: ' +
          username + '</span>' + '<div class="message">' + 
          text + '</div></div>';
        return myHTML;
    }

  $(document).ready(function() {

      var dal = new Dal();
      var model = new Model("testroom", "anonymous", dal);

      // listener for the room and username
      model.addListener("room&username", function(data) {
          $("#currentroom").text("current room: " + model.room);      
          $("#currentusername").text("current username: " + model.username);
      });

      // listener for a new message
      model.addListener("getMessagesSuccess", function() {
          var mh = $("#messagehistory");
          mh.empty();
          for(var i = 0; i < model.messages.length; i++) {
              var m = model.messages[i];
              mh.append(messageTemplate(m.time, m.username, m.text));
          }
          mh.scrollTop(mh.prop("scrollHeight"));
      });

      // listener for a message retrieval failure
      model.addListener("getMessagesFailure", function() {
          // TODO popup or something
      });
      
      // listener for a message persistence failure
      model.addListener("saveMessageFailure", function() {
          // TODO popup or something
      });

      // listener for a new status update
      model.addListener("addStatus", function(s) {
          var st = $("#status");
          st.append('<p class="' + s.type + '">' + s.message + '</p>');
          st.scrollTop(st.prop("scrollHeight"));
      });

      // listener for a successful message save
      model.addListener("saveMessageSuccess", function() {
          $("#text").val("");
      });
      
      $("#savemessage").click(function() {
          var text = $("#text").val();
          model.addMessage(text);
      });

      $("#updateconfig").click(function() {
          var username = $("#username").val();
          var room = $("#room").val();
          model.setRoomAndUserName(room, username);
      });

      $("#togglestatus").click(function() {
          $("#status").toggle(500);
      });
      
      $("#showconfig").click(function() {
          $("#setconfig").toggle(500); 
      }).click();

      model._notifyListeners("room&username");
      model.startGetMessages();

  });

</script>

</body>

</html>

