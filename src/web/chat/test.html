<!DOCTYPE html5>
<html>

<head>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
  <link rel="stylesheet" href="qunit.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="test.css" type="text/css" media="screen" />
  <script type="text/javascript" src="qunit.js"></script>
  <script type="text/javascript" src="model.js"></script>
  <script type="text/javascript" src="dal.js"></script>
  <script type="text/javascript" src="behavior.js"></script>

  <script>
  $(document).ready(function(){
      
      
      
      module("behavior");
      
      test("message template", function() {
          var behavior = new Behavior($, new Model("abc", "def", {addListener: function() {}}));
          var temp = behavior.messageTemplate("ab", "cd", "ef");
          ok(temp.length > 50); // arbitrary number ... 
      });
      
      test("set DOM current room and username", function() {
          var behavior = new Behavior($, new Model("abc", "def", {addListener: function() {}}));
          ok($("#currentusername").text() !== "def"); // make sure the later tests aren't accidentally passing 
          behavior.addBehavior();
          behavior.setCurrentRoomAndUsername();
          equal("current username: def", $("#currentusername").text(), "current user name");
          equal("current room: abc", $("#currentroom").text(), "current room");
      });
      
      test("display messages", function() {
          var model = new Model("abc", "def", {addListener: function() {}});
          var behavior = new Behavior($, model);
          behavior.addBehavior();
          equal($("#messagehistory").children().length, 0, "messages displayed before");
          model._setMessages([{time: "", username: "", text: ""}, {time: "", username: "", text: ""}]);
          equal($("#messagehistory").children().length, 2, "messages displayed after");
      });
      
      test("wipe message text", function() {
          expect(5);
          var dal = {
                  addListener: function() {}
          };
          var model = new Model("abc", "def", dal);
          dal.saveMessage = function() {model._notifyListeners("saveMessageSuccess");};

          var behavior = new Behavior($, model);
          behavior.addBehavior();

          equal($("#text").val(), "", "text before");
          $("#text").val("a and b the c of d");
          equal($("#text").val(), "a and b the c of d", "text set");
          behavior.clearText();
          equal($("#text").val(), "", "text after");
          
          $("#text").val("a and b the c of d");
          equal($("#text").val(), "a and b the c of d", "text before saving message");
          behavior.saveMessage("a and b the c of d");
          // or $("#savemessage").click(); ??? 
          equal($("#text").val(), "", "text after saving message");
          
      });
      
      test("update configuration", function() {
          var dal = {
                  addListener: function() {}
          };
          var model = new Model("", "", dal);
          var be = new Behavior($, model);
          be.addBehavior();
          
          $("#username").val("matt");
          $("#room").val("bedroom");
          
          ok(model.username !== "matt");
          
          $("#updateconfig").click();
          
          equal(model.room, "bedroom");
          equal(model.username, "matt");          
      });
      
      
      
      module("data access layer");
      
      test("listeners", function() {
          
          var dal = new Dal();
          var saveS = 0,
              saveF = 0,
              getS = 0,
              getF = 0;
          dal.addListener("saveMessageSuccess", function() {
              saveS++;
          });
          dal.addListener("saveMessageFailure", function() {
              saveF++;
          });
          dal.addListener("getMessagesSuccess", function() {
              getS++;
          });
          dal.addListener("getMessagesFailure", function() {
              getF++;
          });
         
          dal._notifyListeners("saveMessageFailure");
          dal._notifyListeners("saveMessageSuccess");
          dal._notifyListeners("getMessagesSuccess");
          dal._notifyListeners("saveMessageFailure");
          dal._notifyListeners("getMessagesSuccess");
          dal._notifyListeners("getMessagesFailure");
          dal._notifyListeners("getMessagesFailure");
          dal._notifyListeners("getMessagesSuccess");
          dal._notifyListeners("getMessagesSuccess");
          dal._notifyListeners("saveMessageFailure");
          
          equal(saveS, 1, "save success");
          equal(getF,  2, "get failure");
          equal(saveF, 3, "save success");
          equal(getS,  4, "get success");
      });
      
      asyncTest("get messages", function() {
          var dal = new Dal();
          var failed = 0,
              succeeded = 0;
          dal.addListener("getMessagesSuccess", function() {succeeded++;});
          dal.addListener("getMessagesFailure", function() {failed++;});
          
          dal.getMessages("testroom");
          dal.getMessages("testroom");
          
          function end() {
              equal(succeeded, 2, "successful gets");
              equal(failed, 0, "failing gets");
              start();
          }
          
          setTimeout(end, 5000); 
      });
      
      asyncTest("save message", function() {
          var dal = new Dal();
          var failed = 0,
              succeeded = 0;
          dal.addListener("saveMessageSuccess", function() {succeeded++;});
          dal.addListener("saveMessageFailure", function() {failed++;});
          
          dal.saveMessage("anonymous", "testroom", "automated test message");
          dal.saveMessage("anonymous", "testroom", "automated test message");
          
          function end() {
              equal(succeeded, 2, "successful saves");
              equal(failed, 0, "failing saves");
              start();
          }
          
          setTimeout(end, 5000);
      });
      
      
      
      module("model");
      
      test("room and username", function() {
          expect(2);
          var model = new Model("testroom", "anonymous", {addListener: function() {}});
          equal(model.room, "testroom");
          equal(model.username, "anonymous");
      });
      
      test("set room and username", function() {
          expect(9);
          var model = new Model("a", "b", {addListener: function() {}});
          var nu = "";
          var nr = "";
          var errors = [];
          model.addListener("room&username", function(error) {
              if(!error) {
                  nn = model.username;
                  nr = model.room;
              } else {
                  errors.push(error.error);
              }
          });
          
          model.setRoomAndUserName("def", "");
          equal(1, errors.length);
          equal("a", model.room);
          equal("b", model.username);
          
          model.setRoomAndUserName("", "xyz");
          equal(2, errors.length);
          equal("a", model.room);
          equal("b", model.username);
          
          model.setRoomAndUserName("abc", "ghi");
          equal(2, errors.length);
          equal("abc", model.room);
          equal("ghi", model.username);
      });
      
      test("call saveMessageSuccess and saveMessageFailure listeners", function() {
          expect(2);
          var dal = {addListener: function() {}};
          dal.saveMessage = function(x) {
              if(x) {
                  model._notifyListeners("saveMessageSuccess");
              } else {
                  model._notifyListeners("saveMessageFailure");
              }
          };
          var model = new Model("testroom", "anonymous", dal);
          var successCalled = false;
          var failureCalled = 0;
          model.addListener("saveMessageSuccess", function() {successCalled = true;});
          model.addListener("saveMessageFailure", function() {failureCalled++;});
          model.addMessage("abc");
          model.addMessage("");
//          model.addMessage(false);// false is probably converted to string "false" 
          ok(successCalled);
          equal(failureCalled, 1);
      });
      
      test("event type", function() {
          var model = new Model("testroom", "anonymous", {addListener: function() {}});
          var x = false;
          model.addListener("room&username", function() {
              x = true;
          });
          model.setRoomAndUserName("abc", "def");
          ok(x);
      });

      test("multiple listeners to one event type", function() {
          expect(3);

          var model = new Model("testroom", "anonymous", {addListener: function() {}});
          var x = 4;
          
          model.addListener("addStatus", function() {x += 3;});
          model.addListener("addStatus", function() {x *= 4;});
          model.addStatus({type: 'success', message: 'did something'});

          equal(x, 28);
          equal(model._listeners["addStatus"].length, 2);

          model.addStatus({type: 'success', message: 'did something'});

          equal(x, 124);
      });

      asyncTest("call get messages failure", function() {
          expect(5);
          
          var dal = {};
          dal.getMessages = function(room) {
                  equal(room, "testroom", "room to fetch messages for");
                  dal.getMessagesFailure("some error message");
          },
          dal.addListener = function(e, f) {
              dal[e] = f;
          }
              
          var model = new Model("testroom", "anonymous", dal);
          model.addListener("getMessagesFailure", function(error) {
              equal("some error message", error, "error message");
          });
          
          model.startGetMessages();
          
          function end() {
              model.stopGetMessages();
              equal(2, model.statuses.length, "number of status updates");
//              equal(0, called, "number of times callback was called");
              start();
          }
          
          setTimeout(end, 7000);
      });
      
      asyncTest("get messages aynchronous", function() {
          expect(1);
          var called = 0;
          
          function inc() {
              called++;
          }
          
          var dal = {
              getMessages: function() {inc();},
              addListener: function() {}
          };
          
          var model = new Model("testroom", "anonymous", dal);
          model.startGetMessages();
          
          function end() {
              model.stopGetMessages();
              equal(3, called, "number of times callback was called");
              start();
          }
          
          setTimeout(end, 10000); // wait 10 seconds 
      });

      asyncTest("stop getting messages", function() {
          expect(1);
          var called = 0;
          
          function inc() {
              called++;
          }
          
          var dal = {
              getMessages: function() {inc();},
              addListener: function() {}
          };
          
          var model = new Model("testroom", "anonymous", dal);
          model.startGetMessages();
          model.stopGetMessages();
          
          function end() {
              equal(0, called, "number of times callback was called");
              start();
          }
          
          setTimeout(end, 10000); // wait 10 seconds 
      });
      
  });
  </script>
  
</head>
 
 <body>
  <h1 id="qunit-header">QUnit example</h1>
  <h2 id="qunit-banner"></h2>
  <div id="qunit-testrunner-toolbar"></div>
  <h2 id="qunit-userAgent"></h2>
  <ol id="qunit-tests"></ol>
  <div id="qunit-fixture">test markup, will be hidden</div>
  <div id="test_elements" class="myhidden">
    <div id="currentroom"></div>
    <div id="currentusername"></div>
    <div id="messagehistory"></div>   
    <div id="newmessage">
      <textarea id="text"></textarea>
      <button id="savemessage"></button>
    </div>
    <input name="username" id="username" /></td>
    <input id="room" name="room"/></td>
    <button id="updateconfig"></button>
  </div>
 </body>

</html>
