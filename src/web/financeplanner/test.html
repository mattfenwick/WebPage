<!DOCTYPE html5>
<html>

<head>
  <script type="text/javascript" src="jquery1.7.2.js"></script>
  <link rel="stylesheet" href="qunit.css" type="text/css" media="screen" />
  <script type="text/javascript" src="qunit.js"></script>
  <script type="text/javascript" src="finance.js"></script>
  <script type="text/javascript" src="display.js"></script>
  <link rel="stylesheet" type="text/css" href="finance.css" />

  <script>
  $(document).ready(function(){
      
      
    module("Periodic Transaction");
      
    test("initialization", function() {
      try {
        new PerTran("", "", 'month', 'credit');
        ok(0, "didn't catch bad amount");
      } catch(e) {
        ok(1, "caught bad amount");
      }

    });
     
    test("get amount", function() {
      var ptran = new PerTran(32, "", "month", "debit");
      equal(ptran.getAmount(), -32);

      var ptran2 = new PerTran(73.75, "", "month", "credit");
      equal(ptran2.getAmount(), 73.75); 
    });
     
    test("get year amount", function() {
      var ptran = new PerTran(32, "", "month", "debit");
      equal(ptran.getYearAmount(), -384);

      var ptran2 = new PerTran(12.25, "", "year", "credit");
      equal(ptran2.getAmount(), 12.25); 
    });

    test("bad period", function() {
      var made = 0;
      try {
        var pgood = new PerTran(75.32, 'abc', 'month', 'credit');
        made++;
 
        var pbad = new PerTran(75.32, 'def', 'week', 'credit');
        made++;
      } catch(e) {

      }
      equal(1, made);
    });

    test("bad type", function() {
      var made = 0;
      try {
        var pgood = new PerTran(75.32, 'abc', 'month', 'credit');
        made++;
 
        var pbad = new PerTran(75.32, 'def', 'month', 'deposit');
        made++;
      } catch(e) {

      }
      equal(1, made);
    });

    test("bad amount", function() {
      var made = 0;
      try {
        var pgood = new PerTran(75.32, 'abc', 'month', 'credit');
        made++;
 
        var pbad = new PerTran("hello", 'def', 'month', 'credit');
        made++;
      } catch(e) {

      }
      equal(1, made);
    });

    test("set amount: decimals and no negatives", function() {
      var p = new PerTran(0, 'abc', 'month', 'credit');
      try {
        p.setAmount("75.");
        ok(1, "decimal point is fine");
      } catch(e) {
        ok(0, "decimal point");
      }
      
      try {
        p.setAmount("75.32");
        ok(1, "2 decimal places");
      } catch(e) {
        ok(0, "2 decimal places");        
      }


      try {
        p.setAmount("-11");
        ok(0, "negative number");
      } catch(e) {
        ok(1, "negative number");        
      }

      try {
        p.setAmount(123.456);
        ok(0, "too many decimal places");
      } catch(e) {
        ok(1, "decimal places");        
      }

      try {
        p.setAmount(.01);
        ok(1, "decimal only");
        p.setAmount(".01");
        ok(1, "decimal only, string version");
      } catch(e) {
        ok(0, "decimal only, number or string version");        
      }
    });

    test("listener", function() {
      var pgood = new PerTran(75.32, 'abc', 'month', 'credit');
      var ct = 0;
      pgood.setListener(function() {ct++;});

      pgood.setType('debit');
      equal(ct, 1);

      pgood.setPeriod('year');
      equal(ct, 2);
    });

    test("remove listener", function() {
      var pgood = new PerTran(75.32, 'abc', 'month', 'credit');
      var ct = 0;
      pgood.setListener(function() {ct++;});

      pgood.setType('debit');
      equal(ct, 1);

      pgood.setListener(null);
      pgood.setPeriod('year');
      equal(ct, 1, "listener not called again after removal");
    });




    module("CashFlow");

    test("add and remove Periodic Transaction", function() {
      var cf = new CashFlow("abc");

      equal(Object.keys(cf.getPerTrans()).length, 0);

      cf.addPerTran(new PerTran(12.3, "", "month", "debit"));

      try {
        cf.removePerTran(173);
        ok(0, "removed non-existent");
      } catch(e) {
        ok(1);
      }

      equal(Object.keys(cf.getPerTrans()).length, 1);

      var id = cf.addPerTran(new PerTran(22, "whatever", "year", "debit"));

      equal(Object.keys(cf.getPerTrans()).length, 2);

      try {
        cf.removePerTran(173);
        ok(0, "successfully removed non-existent");
      } catch(e) {
        ok(1);
      }

      equal(Object.keys(cf.getPerTrans()).length, 2);

      cf.removePerTran(id);

      equal(Object.keys(cf.getPerTrans()).length, 1);
    });

    test("get week, month, year amount", function() {
      var cf = new CashFlow("def");

      cf.addPerTran(new PerTran(22, "", "month", "debit"));
      var year = cf.calculateYear();
      equal(year.total, -264, "year total");
      equal(year.credits, 0, "year credits");
      equal(year.debits, -264, "year debit");
      ok(Math.abs(cf.calculateMonth().total + 22) < 0.0001, "month value");
      ok(Math.abs(cf.calculateWeek().total - (-264 * 7 / 365)) < 0.0001, "week value");

      cf.addPerTran(new PerTran(175, "", "year", "credit"));
      equal(cf.calculateYear().total, -89, 'year value');
      var month = cf.calculateMonth();
      ok(Math.abs(month.total - (-89 / 12)) < 0.0001, "month total");
      ok(Math.abs(month.credits - (175 / 12)) < 0.0001, "month credits");
      ok(Math.abs(month.debits + 22) < 0.0001, "month debits");
      ok(Math.abs(cf.calculateWeek().total - (-89 * 7 / 365)) < 0.0001, "week value");

      cf.addPerTran(new PerTran(5, "", "month", "credit"));
      equal(cf.calculateYear().total, -29, 'year value');
      ok(Math.abs(cf.calculateMonth().total - (-29 / 12)) < 0.0001, "month value");
      var week = cf.calculateWeek();
      ok(Math.abs(week.total - (-29 * 7 / 365)) < 0.0001, "week total");
      ok(Math.abs(week.credits - (235 * 7 / 365)) < 0.0001, "week credits");
      ok(Math.abs(week.debits - (-264 * 7 / 365)) < 0.0001, "week debits");
    });

    test("add and notify listeners", function() {
      // test that listeners can be added, and are called appropriately
      var cf = new CashFlow("ghi");

      var ct = 0;
      cf.addListener(function() {ct++;});
      var expectedMessage = "removePerTran";
      cf.addListener(function(args) {equal(args.message, expectedMessage, "message passed to listeners");});

      cf._notify({"message": "removePerTran"});
      equal(ct, 1, "number of times ct inc'ed");

      expectedMessage = "addPerTran";
      cf._notify({'message': "addPerTran"});
      equal(ct, 2, "number of times ct inc'ed");

      cf.addPerTran(new PerTran(0, "", "month", "credit"));
      equal(ct, 3, "number of times ct inc'ed");
    });

    test("listeners not called after removal", function() {
      // test that the listeners are no longer called after .removeListeners() is called
      var cf = new CashFlow("jkl");

      var ct = 0;
      cf.addListener(function() {ct++;});

      var perTran = new PerTran(0, "", "month", "credit");
      var id = cf.addPerTran(perTran);
      equal(ct, 1, "number of times ct inc'ed");

      perTran.setAmount(21);
      equal(ct, 2, "number of times ct inc'ed");

      cf.removeListeners();

      perTran.setDescription("abc");
      equal(ct, 2, "number of times ct inc'ed");

      cf.removePerTran(id);
      equal(ct, 2, "number of times ct inc'ed");

      cf.addPerTran(new PerTran(27, "desc of some kind", 'year', 'debit'));
      equal(ct, 2, "number of times ct inc'ed");
    });

    test("CashFlow name", function() {
      var cf = new CashFlow("hello");
      try {
        var cf2 = new CashFlow("");
        ok(0, "didn't catch bad name");
      } catch(e) {
        ok(1, "caught bad name");
      }
      try {
        var cf3 = new CashFlow({hello: 3});
        ok(0, "didn't catch bad type for name");
      } catch(e) {
        ok(1, "caught bad type for name");
      }
    });
    
    test("events: propagation from changes to PerTrans", function() {
      var events = {
        'addPerTran': 0,
        'removePerTran': 0,
        'valueChange': 0,
        '1': 0,
        '2': 0
      };
      
      var cf = new CashFlow("cf name");      
      function f(data) {
        events[data.message]++;
        events[data.id]++;
      }
      cf.addListener(f);
      
      var pt1 = new PerTran(1, "", "month", "debit");
      var pt2 = new PerTran(2, "", "year", "credit");
      var id1 = cf.addPerTran(pt1);
      var id2 = cf.addPerTran(pt2);
      
      pt1.setAmount(4);
      pt1.setPeriod('year');
      pt1.setPeriod('year'); // what if there's no change? ...
      pt2.setDescription("some string");
      pt2.setType("debit");
      
      equal(events.addPerTran, 2, "addPerTran");
      equal(events.removePerTran, 0, "removePerTran");
      equal(events.valueChange, 5, "valueChange");
      equal(events['1'], 4, 'id 1'); // 1 for the addition, 3 for the changes
      equal(events['2'], 3, 'id 2');
    });




    module("Analysis");

    test("add, remove, get cash flow", function() {
      var an = new Analysis();
      an.addCashFlow(new CashFlow("abc"));
      an.addCashFlow(new CashFlow("bdf"));

      equal(an.getCashFlow("abc").name, "abc");
      equal(an.getCashFlows().length, 2);

      an.removeCashFlow("abc");

      equal(an.getCashFlows().length, 1);
    });
    
    test("events: messages and cf names passed", function() {
      var an = new Analysis();
      var counts = {
        addCashFlow: 0,
        removeCashFlow: 0,
        setActiveCashFlow: 0,
        'a and b': 0,
        'f': 0
      };
      
      an.addListener(function(data) {
        if(!(data.name in counts)) {
          ok(0, "bad name: " + data.name + " from event " + data.message);
        }
        counts[data.message]++;
        counts[data.name]++;
      });
      
      an.addCashFlow(new CashFlow("a and b"));      
      an.addCashFlow(new CashFlow("f"));
      an.removeCashFlow("a and b");      
      an.setActiveCashFlow("f");
            
      equal(counts.addCashFlow, 2);
      equal(counts.removeCashFlow, 1);
      equal(counts.setActiveCashFlow, 1);
      equal(counts['a and b'], 2);
      equal(counts.f, 2);
      
    });
    
    
    
    module("AnalyzeView");
    
    asyncTest("display results", function() {
      var an = new Analysis();
      var cf = new CashFlow("my name");
      an.addCashFlow(cf);
      cf.addPerTran(new PerTran(12, "", "month", "credit"));
      cf.addPerTran(new PerTran(40, "", "year", "debit"));
      
      var aview = new AnalyzeView(an);
      
      function change() {
        var cf2 = new CashFlow("my name");
        cf2.addPerTran(new PerTran(1, "", "year", "credit"));
        cf2.addPerTran(new PerTran(400, "", "month", "debit"));
        aview.setCashFlow(cf2);
        
        start();
        
        ok(1);
      }
      
      setTimeout(change, 4);//000);
    });
    
    
    module("GridView");
    // need to test:
    //   listeners removed properly when cash flow switched
    //   PerTrans added correctly to underlying CashFlow    
    //   PerTrans updated correctly    
    
    asyncTest("display empty CashFlow for editing", function() {
      var cf = new CashFlow("hello");
      cf.addPerTran(new PerTran(30, "", "month", "debit"));
      
      var gview = new GridView(cf);
      
      function change() {
        var cf2 = new CashFlow("hi there");
        var id = cf2.addPerTran(new PerTran(40, "oh my goodness round 2!!!", "year", "credit"));
        gview.setCashFlow(cf2);
        
        start();
        ok(1);
      }
      
      setTimeout(change, 4000);
    });
      
  });
  </script>
  
</head>
 
 <body>
  <h1 id="qunit-header">QUnit example</h1>
  <h2 id="qunit-banner"></h2>
  <div id="qunit-testrunner-toolbar"></div>
  <h2 id="qunit-userAgent"></h2>
  <ol id="qunit-tests"></ol>
  <div id="qunit-fixture">test markup, will be hidden</div>
  <div id="test_elements" class="myhidden">
   <!-- I put my stuff here -->
  </div>
  <div id="visible_elements">
   <table id="results" border="2"></table>
   <table id="pertrans" border="2"></table>
  </div>
 </body>

</html>
