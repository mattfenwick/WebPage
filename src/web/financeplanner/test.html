<!DOCTYPE html5>
<html>

<head>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
  <link rel="stylesheet" href="qunit.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="test.css" type="text/css" media="screen" />
  <script type="text/javascript" src="qunit.js"></script>
  <script type="text/javascript" src="finance.js"></script>

  <script>
  $(document).ready(function(){
      
      
      
    module("Periodic Transaction");
      
    test("initialization", function() {
      try {
        new PerTran("", "", 'month', 'credit');
        ok(0, "didn't catch bad amount");
      } catch(e) {
        ok(1, "caught bad amount");
      }

    });
     
    test("get amount", function() {
      var ptran = new PerTran(32, "", "month", "debit");
      equal(ptran.getAmount(), -32);

      var ptran2 = new PerTran(73.75, "", "month", "credit");
      equal(ptran2.getAmount(), 73.75); 
    });
     
    test("get year amount", function() {
      var ptran = new PerTran(32, "", "month", "debit");
      equal(ptran.getYearAmount(), -384);

      var ptran2 = new PerTran(12.25, "", "year", "credit");
      equal(ptran2.getAmount(), 12.25); 
    });

    test("bad period", function() {
      var made = 0;
      try {
        var pgood = new PerTran(75.32, 'abc', 'month', 'credit');
        made++;
 
        var pbad = new PerTran(75.32, 'def', 'week', 'credit');
        made++;
      } catch(e) {

      }
      equal(1, made);
    });

    test("bad type", function() {
      var made = 0;
      try {
        var pgood = new PerTran(75.32, 'abc', 'month', 'credit');
        made++;
 
        var pbad = new PerTran(75.32, 'def', 'month', 'deposit');
        made++;
      } catch(e) {

      }
      equal(1, made);
    });

    test("bad amount", function() {
      var made = 0;
      try {
        var pgood = new PerTran(75.32, 'abc', 'month', 'credit');
        made++;
 
        var pbad = new PerTran("hello", 'def', 'month', 'credit');
        made++;
      } catch(e) {

      }
      equal(1, made);
    });

    test("listener", function() {
      var pgood = new PerTran(75.32, 'abc', 'month', 'credit');
      var ct = 0;
      pgood.setListener(function() {ct++;});

      pgood.setType('debit');
      equal(ct, 1);

      pgood.setPeriod('year');
      equal(ct, 2);
    });

    test("remove listener", function() {
      var pgood = new PerTran(75.32, 'abc', 'month', 'credit');
      var ct = 0;
      pgood.setListener(function() {ct++;});

      pgood.setType('debit');
      equal(ct, 1);

      pgood.setListener(null);
      pgood.setPeriod('year');
      equal(ct, 1);
    });




    module("CashFlow");

    test("add and remove Periodic Transaction", function() {
      var cf = new CashFlow("abc");

      equal(cf.getPerTrans().length, 0);

      cf.addPerTran(new PerTran(-12.3, "", "month", "debit"));

      try {
        cf.removePerTran(173);
        ok(0, "successfully removed non-existent");
      } catch(e) {
        ok(1);
      }

      equal(cf.getPerTrans().length, 1);

      var id = cf.addPerTran(new PerTran(22, "whatever", "year", "debit"));

      equal(cf.getPerTrans().length, 2);

      try {
        cf.removePerTran(173);
        ok(0, "successfully removed non-existent");
      } catch(e) {
        ok(1);
      }

      equal(cf.getPerTrans().length, 2);

      cf.removePerTran(id);

      equal(cf.getPerTrans().length, 1);
    });

    test("get week, month, year amount", function() {
      var cf = new CashFlow("def");

      cf.addPerTran(new PerTran(22, "", "month", "debit"));
      equal(cf.calculateYear(), -264, "year value");
      ok(Math.abs(cf.calculateMonth() - (-264 / 12)) < 0.0001, "month value");
      ok(Math.abs(cf.calculateWeek() - (-264 * 7 / 365)) < 0.0001, "week value");

      cf.addPerTran(new PerTran(175, "", "year", "credit"));
      equal(cf.calculateYear(), -89, 'year value');
      ok(Math.abs(cf.calculateMonth() - (-89 / 12)) < 0.0001, "month value");
      ok(Math.abs(cf.calculateWeek() - (-89 * 7 / 365)) < 0.0001, "week value");

      cf.addPerTran(new PerTran(5, "", "month", "credit"));
      equal(cf.calculateYear(), -29, 'year value');
      ok(Math.abs(cf.calculateMonth() - (-29 / 12)) < 0.0001, "month value");
      ok(Math.abs(cf.calculateWeek() - (-29 * 7 / 365)) < 0.0001, "week value");
    });

    test("add and notify listeners", function() {
      // test that listeners can be added, and are called appropriately
      var cf = new CashFlow("ghi");

      var ct = 0;
      cf.addListener(function() {ct++;});
      var expectedMessage = "removePerTran";
      cf.addListener(function(args) {equal(args.message, expectedMessage, "message passed to listeners");});

      cf._notify({"message": "removePerTran"});
      equal(ct, 1, "number of times ct inc'ed");

      expectedMessage = "addPerTran";
      cf._notify({'message': "addPerTran"});
      equal(ct, 2, "number of times ct inc'ed");

      cf.addPerTran(new PerTran(0, "", "month", "credit"));
      equal(ct, 3, "number of times ct inc'ed");
    });

    test("cf's perTran listeners, and remove listeners", function() {
      // test that the listeners are no longer called after .removeListeners() is called
      var cf = new CashFlow("jkl");

      var ct = 0;
      cf.addListener(function() {ct++;});

      var perTran = new PerTran(0, "", "month", "credit");
      var id = cf.addPerTran(perTran);
      equal(ct, 1, "number of times ct inc'ed");

      perTran.setAmount(21);
      equal(ct, 2, "number of times ct inc'ed");

      cf.removeListeners();

      perTran.setDescription("abc");
      equal(ct, 2, "number of times ct inc'ed");

      cf.removePerTran(id);
      equal(ct, 2, "number of times ct inc'ed");
    });

    test("CashFlow name", function() {
      var cf = new CashFlow("hello");
      try {
        var cf2 = new CashFlow("");
        ok(0, "didn't catch bad name");
      } catch(e) {
        ok(1, "caught bad name");
      }
      try {
        var cf3 = new CashFlow({hello: 3});
        ok(0, "didn't catch bad type for name");
      } catch(e) {
        ok(1, "caught bad type for name");
      }
    });




    module("Analysis");

    test("add, remove, get cash flow", function() {
      var an = new Analysis();
      var id = an.addCashFlow(new CashFlow("abc"));
      var id2 = an.addCashFlow(new CashFlow("bdf"));

      equal(an.getCashFlow(id).name, "abc");
      an.removeCashFlow(id);

      ok(0, "not implemented");
    });
      
  });
  </script>
  
</head>
 
 <body>
  <h1 id="qunit-header">QUnit example</h1>
  <h2 id="qunit-banner"></h2>
  <div id="qunit-testrunner-toolbar"></div>
  <h2 id="qunit-userAgent"></h2>
  <ol id="qunit-tests"></ol>
  <div id="qunit-fixture">test markup, will be hidden</div>
  <div id="test_elements" class="myhidden">
   <!-- I put my stuff here -->
  </div>
 </body>

</html>
