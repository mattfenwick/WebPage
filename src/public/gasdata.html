<html>

  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
  <script type="text/javascript" src="highcharts.js"></script>

<script type="text/javascript">

function ChartModel(json, indvar, depvars) {
	if (!(this instanceof arguments.callee))
		throw new Error("Constructor called as a function");
	var rows = new Object();
	json.rows.map(function(row) {
		var key = row[indvar];
		rows[key] = row;
	});
	this.rows = rows;
	this.headers = json.headers;
	this.getRow = function(key) {
		return this.rows[key];
	}
	mydvars = new Object();
	depvars.map(function(dvar) {
		mydvars[dvar] = 1;
	});
        this.indvar = indvar;
	this.depvars = mydvars;
	this.getSeries = function(header) {
		if (header != indvar && !(mydvars[header])) {
			alert("non-existent column: " + header);
		}
		var res = new Array();
		for ( var rowkey in rows) {
			res.push(rows[rowkey][header]);
		}
		return res;
	}
}


/**
 * 
 */
function formatTable (chartModel) {
	var key = chartModel.indvar;
	var keys = chartModel.getSeries(key);
	var myhtml = ['<table border="2"><tr>'];
	var headers = Array();
	headers.push(key);
	for (var head in chartModel.depvars) {
		headers.push(head);
	}
	for(var j = 0; j < headers.length; j++) {
		myhtml.push('<th>' + headers[j] + '</th>');
	}
	myhtml.push('</tr>');
	for(var i = 0; i < keys.length; i++) {
		myhtml.push('<tr>');
		var row = chartModel.getRow(keys[i]);
		for(var k = 0; k < headers.length; k++) {
			var val = row[headers[k]];
			if(!val) {val = '-';};
			myhtml.push('<td>' + val + '</td>');
		}
		myhtml.push('</tr>');
	}
	myhtml.push('</table>');
	return myhtml.join();
}
    


function prepareReport(table, key, depvars, callback) {
	var xmlhttp = new XMLHttpRequest(); // assume this works
	xmlhttp.onreadystatechange = function() {
		if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
			var m = new ChartModel(JSON.parse(xmlhttp.responseText), key,
					depvars);
			callback(m);
		} else {
			// alert('oops');
		}
	}
	xmlhttp.open("GET", "gas2.php?table=" + table, true);
	var res = xmlhttp.send();
}

function getChart(title, location, keys, xtitle) {
	var chart = new Highcharts.Chart( {
		chart : {
			renderTo : location,
			defaultSeriesType : 'bar',
			zoomType : 'xy'
		},
		title : {
			text : title
		},
		xAxis : {
			title : {
				enabled : true,
				text : xtitle
			},
			startOnTick : false,
			endOnTick : false,
			showLastLabel : true,
			categories : keys
		},
		yAxis : {
			title : {
				text : 'Dependent variable'
			}
		},
		tooltip : {
			formatter : function() {
				return this.x + ": " + this.y;
			}
		},
		legend : {
			layout : 'vertical',
			align : 'left',
			verticalAlign : 'top',
			x : 5,
			y : 5,
			floating : false,
			backgroundColor : '#FFFFFF',
			borderWidth : 1
		},
		plotOptions : {
			scatter : {
				marker : {
					radius : 5,
					states : {
						hover : {
							enabled : true,
							lineColor : 'rgb(100,100,100)'
						}
					}
				},
				states : {
					hover : {
						marker : {
							enabled : false
						}
					}
				}
			}
		}
	});
	return chart;
}


var callback = function(chartModel) {
	var chart1 = getChart("Gasoline fill-ups by brand", "brand", chartModel.getSeries("brand"), "gasoline brand");
	chart1.addSeries( {
                name : "number of fill-ups",
		data : chartModel.getSeries("fillups").map(function(s) {return parseInt(s);})
	});
	chart1.addSeries( {
                name : "average price per gallon",
		data : chartModel.getSeries("average price").map(function(s) {return parseFloat(s);})
	});
	chart1.addSeries( {
                name : "average gallons per fillup",
		data : chartModel.getSeries("average gallons").map(function(s) {return parseFloat(s);})
	});
	chart1.addSeries( {
                name : "total gallons",
		data : chartModel.getSeries("total gallons").map(function(s) {return parseFloat(s);})
	});
        document.getElementById("brandtable").innerHTML = formatTable(chartModel);
}

prepareReport("brand", "brand", [ "fillups", "average price", "average gallons", "total gallons" ], callback);




var callback2 = function(chartModel) {
	var chart2 = getChart("Gasoline fill-ups by tank", "tank", chartModel.getSeries("tank number"), "tank number");
	chart2.addSeries( {
                name : "gallons",
		data : chartModel.getSeries("gallons").map(function(s) {return parseFloat(s);})
	});
	chart2.addSeries( {
                name : "price per gallon",
		data : chartModel.getSeries("price per gallon").map(function(s) {return parseFloat(s);})
	});
	chart2.addSeries( {
                name : "miles",
		data : chartModel.getSeries("miles").map(function(s) {return parseInt(s);})
	});
	chart2.addSeries( {
                name : "miles per gallon",
		data : chartModel.getSeries("miles per gallon").map(function(s) {return parseFloat(s);})
	});
	chart2.addSeries( {
                name : "days since previous fill-up",
		data : chartModel.getSeries("days").map(function(s) {return parseInt(s);})
	});
	chart2.addSeries( {
                name : "mileage",
		data : chartModel.getSeries("mileage").map(function(s) {return parseInt(s);})
	});
        document.getElementById("tanktable").innerHTML = formatTable(chartModel);
}


prepareReport("tank", "tank number", [ "date", "brand", "comment", "gallons", "price per gallon", "miles", "miles per gallon", "days", "mileage" ], callback2);


var callback3 = function(chartModel) {
    document.getElementById("aggregatestable").innerHTML = formatTable(chartModel);
}

prepareReport("aggs", "total miles", ["average miles per tank", "standard deviation, miles per tank", "total gallons", "average gallons per tank", "standard deviation, gallons per tank", "average mpg"], callback3);


</script>
<body>

<body>

<div id="tank"></div>

<div id="brand"></div>

<div id="tanktable"></div>

<div id="brandtable"></div>

<div id="aggregatestable"></div>

</html>