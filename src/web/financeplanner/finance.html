<!doctype html>
<html>
<head>
  <title>Matt's Finance Planner</title>
  <script type="text/javascript" src="jquery1.7.2.js"></script>
  <script type="text/javascript" src="finance.js"></script>
  <link rel="stylesheet" type="text/css" href="finance.css" />
</head>

 <body>

 <div id="current">
  <table id="pertrans" border="2">

   <tr>
    <th>Action</th>
    <th>Amount</th>
    <th>Description</th>
    <th>Period</th>
    <th>Debit/credit</th>
   </tr>

   <tr id="newrow">
    <td><button>Create new</button></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
   </tr>

  </table>
 </div>


 <div id="calculations">
   total for year: <span id="result">0</span>
 </div>

  
 <script type="text/javascript">

 $(document).ready(function() {

  var cf = new CashFlow();

  $("#newrow").click(function() {
    try {
      var ptran = new PerTran(0, "", "month", "debit");
      var id = cf.addPerTran(ptran);
      makeRow(id, ptran);
    } catch(e) {
      alert(e);
    }
  });


  function updateYearTotal() {
    $("#result").text(cf.calculateYear()); 
  }


  function updatePTran(id, sel) {
    try {
      var pt = cf.getPerTran(id);

      pt.setAmount(     $(sel + " .amount"     ).val());
      pt.setDescription($(sel + " .description").val());
      pt.setPeriod(     $(sel + " .period"     ).val());
      pt.setType(       $(sel + " .type"       ).val());

      $(sel + " .inputfield").removeClass("redoutline");
      updateYearTotal();
    } catch(e) {// bug: when some succeed before one fails ... then gui is not consistent with model
      alert("error: " + e);
    }
  }


  function setRowValues(perTran, sel) {
    $(sel + " .amount").val(perTran.amount);
    $(sel + " .description").val(perTran.description);
    $(sel + " .period").val(perTran.period);
    $(sel + " .type").val(perTran.type);
  }


  function makeRow(id, perTran) {
    var rowHTML = [
     '<tr id="' + id + '">',
      '<td>',
       '<button class="deletepertran">Delete</button>',
      '</td>',

      '<td>',
       '<input type="text" class="amount inputfield" />',
      '</td>',

      '<td>',
       '<input type="text" class="description inputfield">',
      '</td>',
 
      '<td>',
       '<select class="period inputfield">',
          '<option value="month">month</option>',
          '<option value="year">year</option>',
        '</select>',
      '</td>',

      '<td>',
       '<select class="type inputfield">',
          '<option value="credit">credit</option>',
          '<option value="debit">debit</option>',
        '</select>',
      '</td>',
     '</tr>'
    ].join('\n');

    // put in the new row right before #newrow
    $("#newrow").before(rowHTML);

    var idsel = "#" + id;
 
    // add the behavior for "delete":
    //   1. remove the PerTran from the model
    //   2. remove the row (it's a <tr>)
    //   3. update the results
    $(idsel + " .deletepertran").click(function() {
      cf.removePerTran(id);
      $(idsel).remove();
      updateYearTotal();
    });

    // given a PerTran and a rowid (row selector), set the values of the widgets
    setRowValues(perTran, idsel);

    // whenever a field is changed (i.e. loses focus):
    //   1. write the changes into the PerTran object
    //   2. update the results
    $(idsel + " .inputfield").change(function() {
      updatePTran(id, idsel);
      updateYearTotal();
    });

  }

 });

 </script>
  
 </body>
</html>